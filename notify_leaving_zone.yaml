blueprint:
  name: Уведомление о зоне
  description: Отправляйте уведомление на устройство, когда человек покидает определенную зону.
  domain: automation
  source_url: https://github.com/bieskholodov/Home-assistant/blob/main/notify_leaving_zone.yaml
  author: bieskholodov
  input:
    person_entity:
      name: Человек
      selector:
        entity:
          filter:
            domain: person
    zone_entity:
      name: Зона
      selector:
        entity:
          filter:
            domain: zone
    notify_device:
      name: Устройство для уведомления
      description: Для получения уведомлений на устройстве необходимо запустить официальное приложение Home Assistant.
      selector:
        device:
          filter:
            integration: mobile_app

triggers:
  trigger: state
  entity_id: !input person_entity

variables:
  zone_entity: !input zone_entity
  # Это состояние человека, когда он находится в этой зоне.
  zone_state: "{{ states[zone_entity].name }}"
  person_entity: !input person_entity
  person_name: "{{ states[person_entity].name }}"

conditions:
  condition: template
  # Первый случай обрабатывает выход из домашней зоны, которая при зонировании имеет особое состояние, называемое «домашняя».
  # Второй случай обрабатывает выход из всех остальных зон.
  value_template: "{{ zone_entity == 'zone.home' and trigger.from_state.state == 'home' and trigger.to_state.state != 'home' or trigger.from_state.state == zone_state and trigger.to_state.state != zone_state }}"

actions:
  - alias: "Notify that a person has left the zone"
    domain: mobile_app
    type: notify
    device_id: !input notify_device
    message: "{{ person_name }} has left {{ zone_state }}"
